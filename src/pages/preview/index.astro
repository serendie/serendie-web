---
import { ComponentPreview } from "../../components/Preview/ComponentPreview";
import { availableComponents } from "../../components/Preview/sampleCodeRegistry";
import "../../index.css";

// Enable static rendering for this page
export const prerender = true;
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Serendie Component Preview</title>
    <style>
      .component-container {
        display: none;
      }
      .component-container.active {
        display: block;
      }
    </style>
  </head>
  <body>
    <div id="app">
      {
        availableComponents.map((componentName) => (
          <div class="component-container" data-component={componentName}>
            <ComponentPreview
              client:only="react"
              componentName={componentName}
            />
          </div>
        ))
      }
    </div>

    <script is:inline>
      // Component Preview initialization
      // This page is a static fallback for development/testing
      // For MCP Apps integration, use the React-based preview at /mcp/ui/preview.html
      function initializePreview() {
        let componentName = "Button"; // default

        // Try to get from URL params (for testing)
        const urlParams = new URLSearchParams(window.location.search);
        const urlComponent = urlParams.get("component");
        if (urlComponent) {
          componentName = urlComponent;
        } else {
          // Fallback: try sessionStorage
          const savedContext = sessionStorage.getItem("preview-context");
          if (savedContext) {
            try {
              const context = JSON.parse(savedContext);
              componentName = context.componentName || context.name || "Button";
              sessionStorage.removeItem("preview-context");
            } catch (e) {
              console.warn("[Preview] Failed to parse saved context:", e);
            }
          }
        }

        console.log("[Preview] Selected component:", componentName);

        // Hide all components
        document.querySelectorAll(".component-container").forEach((el) => {
          el.classList.remove("active");
        });

        // Show only the selected component
        const targetContainer = document.querySelector(
          `[data-component="${componentName}"]`
        );
        if (targetContainer) {
          targetContainer.classList.add("active");
          console.log("[Preview] Showing component:", componentName);
        } else {
          console.warn("[Preview] Component not found:", componentName);
          // Fallback: show first component
          const firstContainer = document.querySelector(".component-container");
          if (firstContainer) {
            firstContainer.classList.add("active");
          }
        }
      }

      // Initialize when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initializePreview);
      } else {
        initializePreview();
      }
    </script>
  </body>
</html>
