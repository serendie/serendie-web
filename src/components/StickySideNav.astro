---
import { styled } from "styled-system/jsx";


const Ul = styled("ul", {
  base: {
    position: "sticky",
    display: "grid",
    gap: "sd.system.dimension.spacing.extraSmall",
    top: "sd.system.dimension.spacing.threeExtraLarge",
    "& a": {
      display: "block",
      borderRadius: "sd.system.dimension.radius.large",
      px: "sd.system.dimension.spacing.medium",
      py: "sd.system.dimension.spacing.small",
      bg: "#EFEEEB",
      textStyle: "sd.system.typography.body.small",
      _highlighted: {
        fontWeight: "700",
      },
    },
  },
});
---

<Ul id="StickySideNav" />

<script>
  const iobserver = new IntersectionObserver(
    (entries) => {
      entries.forEach(({ target, isIntersecting }) => {
        if (isIntersecting) {
          target.classList.add("active");
        } else {
          target.classList.remove("active");
        }
      });

      const sections = document.querySelectorAll("[data-nav-id]");
      let flag = false;
      sections.forEach((section) => {
        const id = section.getAttribute("data-nav-id");
        if (!id) return;
        const nav = sectionNavMap[id];
        if (!nav) return;
        if (!flag && section.classList.contains("active")) {
          nav.setAttribute("data-highlighted", "");
          flag = true;
        } else {
          nav.removeAttribute("data-highlighted");
        }
      });
    },
    { threshold: 0.5 }
  );

  const nav = document.getElementById("StickySideNav");
  const main = nav?.closest("main");
  const sectionNavMap: Record<string, HTMLAnchorElement> = {};

  main?.querySelectorAll("h2").forEach((heading) => {
    const section = heading.closest("section");
    const link = heading.querySelector("a");
    if (!link) return;
    if (!section) return;
    const a = document.createElement("a");
    a.href = link.href;
    a.onclick = (e) => {
      e.preventDefault();
      window.scrollTo({
        top: section.offsetTop - 20,
        behavior: "smooth",
      });
      history.pushState(null, "", link.href);
    };
    a.textContent = heading.textContent;
    iobserver.observe(section);
    section.setAttribute("data-nav-id", link.id);
    sectionNavMap[link.id] = a;
    const li = document.createElement("li");
    li.appendChild(a);
    nav?.appendChild(li);
  });
</script>
